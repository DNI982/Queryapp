/**
 * @file Firestore Security Rules
 * @version 1
 * @description This ruleset enforces a role-based access control model with user-owned data sources. Super-admins manage users and permissions, while users manage their own data sources.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, storing public information and roles.
 * - /pendingUsers/{userId}: User registration requests pending approval.
 * - /dataSources/{dataSourceId}: Data source connections owned by users.
 * - /permissions/{permissionId}: Dynamic permissions for roles, managed by super-admins.
 *
 * Key Security Decisions:
 * - Only super-admins can create pending user requests and approve user roles.
 * - Users can only read their own user profiles.
 * - Data sources are owned by individual users.
 * - Dynamic permissions are managed by super-admins and define role-based access to modules.
 * - Denormalization: Data sources denormalize the `ownerId` field to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (get, list) if isSignedIn() && isOwner(userId) - Allows a signed-in user to read their own profile.
     * @allow (create) if isSignedIn() && isOwner(userId) - Allows a signed-in user to create their own profile.
     * @allow (update) if isSignedIn() && isExistingOwner(userId) - Allows a signed-in user to update their own profile.
     * @deny (delete) - Deleting user profiles is not allowed through client-side rules.
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the authenticated user is the owner of the document.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the authenticated user is the owner of the document and that the document exists
      function isExistingOwner(userId) {
          return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Controls access to pending user registration requests.
     * @path /pendingUsers/{userId}
     * @allow (create) if isSignedIn() - Allows a super-admin to create a new pending user request.
     * @allow (get, list) if isSignedIn() - Allows a super-admin to view pending user requests.
     * @allow (update) if false - Updating pending user requests is not allowed.
     * @allow (delete) if false - Deleting pending user requests is not allowed.
     * @principle Restricts access to pending user data to super-admins only.
     */
    match /pendingUsers/{userId} {
         // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if false; // Only accessible via a privileged backend
      allow list: if false; // Only accessible via a privileged backend
      allow create: if false; // Only accessible via a privileged backend
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to data source connections.
     * @path /dataSources/{dataSourceId}
     * @allow (get, list) if isSignedIn() && isOwner(resource.data.ownerId) - Allows a signed-in user to read their own data sources.
     * @allow (create) if isSignedIn() && request.resource.data.ownerId == request.auth.uid - Allows a signed-in user to create a data source with their user ID as the owner.
     * @allow (update) if isSignedIn() && isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId - Allows a signed-in user to update their own data sources.
     * @allow (delete) if isSignedIn() && isExistingOwner(resource.data.ownerId) - Allows a signed-in user to delete their own data sources.
     * @principle Enforces document ownership for reads and writes.  Validates relational integrity by enforcing ownerId on create and update.
     */
    match /dataSources/{dataSourceId} {

         // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

       // Helper function to check if the authenticated user is the owner of the document.
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }

      // Helper function to check if the authenticated user is the owner of the document and that the document exists
      function isExistingOwner(ownerId) {
          return isOwner(ownerId) && exists(/databases/$(database)/documents/dataSources/$(dataSourceId));
      }

      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to role-based permissions.
     * @path /permissions/{permissionId}
     * @allow (get, list) if false - Prevents listing of permissions from client-side.
     * @allow (create) if false - Prevents creation of permissions from client-side.
     * @allow (update) if false - Prevents updates of permissions from client-side.
     * @allow (delete) if false - Prevents deletion of permissions from client-side.
     */
    match /permissions/{permissionId} {
         // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if false; // Only accessible via a privileged backend
      allow list: if false; // Only accessible via a privileged backend
      allow create: if false; // Only accessible via a privileged backend
      allow update: if false; // Only accessible via a privileged backend
      allow delete: if false; // Only accessible via a privileged backend
    }
  }
}