/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with user-level ownership for data sources.
 * Super-admins manage user roles and permissions.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, including roles.
 * - /pendingUsers/{userId}: Stores pending user registration requests.
 * - /dataSources/{dataSourceId}: Stores data source connection details, owned by a specific user.
 * - /permissions/{permissionId}: Stores role-based permissions, managed by super-admins.
 *
 * Key Security Decisions:
 * - Only super-admins can read or write pending user requests.
 * - Data sources are owned by users, who have full CRUD access.
 * - Only super-admins can manage role-based permissions.
 *
 * Denormalization for Authorization:
 * - The `ownerId` field is used in `/dataSources/{dataSourceId}` to enforce user-level ownership, avoiding the need to query the `/users/{userId}` collection for authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profile documents based on ownership and role.
     * @path /users/{userId}
     * @allow (get, list): Any signed-in user can read user profiles.
     * @allow (create, update, delete): Only the user themselves can create, update, or delete their profile.
     * @deny (create, update, delete): Another user attempts to modify a profile.
     * @principle Enforces user ownership and prevents unauthorized profile modifications.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages pending user registration requests.
     * @path /pendingUsers/{pendingUserId}
     * @allow (get, list): Only super-admins can list and get pending user requests.
     * @allow (create): Only create the user themselves if the uid matches.
     * @allow (update, delete): Only super-admins can update or delete pending user requests.
     * @deny (get, list, create, update, delete): Non-super-admins attempt to access or modify pending user requests.
     * @principle Restricts access to sensitive user registration data to authorized personnel only.
     */
    match /pendingUsers/{pendingUserId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isSuperAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
      }

      function isSelfCreation(pendingUserId) {
        return request.auth.uid == pendingUserId;
      }

      allow get, list: if isSuperAdmin();
      allow create: if isSignedIn() && isSelfCreation(pendingUserId);
      allow update, delete: if isSuperAdmin();
    }

    /**
     * @description Controls access to data source configurations.
     * @path /dataSources/{dataSourceId}
     * @allow (get, list): Any signed-in user can read data sources.
     * @allow (create): Only the owner can create a data source, with `ownerId` matching their UID.
     * @allow (update, delete): Only the owner can update or delete their data sources.
     * @deny (create, update, delete): Unauthorized users attempt to modify data sources.
     * @principle Enforces user ownership for data source management.
     */
    match /dataSources/{dataSourceId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }

      function isExistingOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Manages role-based permissions for different modules.
     * @path /permissions/{permissionId}
     * @allow (get, list): Only super-admins can list and get the permissions.
     * @allow (create, update, delete): Only super-admins can create, update, or delete permissions.
     * @deny (get, list, create, update, delete): Non-super-admins attempt to manage permissions.
     * @principle Restricts permission management to authorized personnel only.
     */
    match /permissions/{permissionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isSuperAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
      }

      allow get, list: if isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }
  }
}