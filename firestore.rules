/**
 * @file Firestore Security Rules
 * @version 2
 * @description This ruleset enforces role-based access control, with a super-admin having the highest level of privilege.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /pendingUsers/{userId}: Stores user registration requests pending approval.
 * - /dataSources/{dataSourceId}: Stores data source connections, with ownership enforced.
 * - /permissions/{permissionId}: Stores role-based permissions, configurable by the super-admin.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Only the super-admin can approve pending users.
 * - Data sources are owned by individual users.
 * - Permissions are managed by the super-admin.
 *
 * Denormalization for Authorization:
 * - The user's role is stored directly in the /users/{userId} document for quick access.
 * - Data sources contain an `ownerId` field to determine ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile information.
     * @path /users/{userId}
     * @allow (create) User with matching ID can create their profile.
     * @allow (get, update, delete) User can access and modify their own profile.
     * @deny (create) User cannot create a profile with a mismatched ID.
     * @deny (list) User cannot list all profiles.
     * @principle Enforces user-ownership and self-creation for profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isSignedIn() {
          return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages pending user registration requests.
     * @path /pendingUsers/{userId}
     * @allow (create) Any signed-in user can request approval for a role.
     * @allow (get, update, delete) Only the super-admin can view, update, and delete pending user requests.
     * @deny (list) Regular users cannot list pending users.
     * @principle Restricts access to pending user requests to the super-admin role.
     */
    match /pendingUsers/{userId} {
        function isSuperAdmin() {
            return request.auth != null && request.auth.token.role == 'super-admin';
        }

        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if isSignedIn() && isSuperAdmin();
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
        allow update: if isSignedIn() && isSuperAdmin();
        allow delete: if isSignedIn() && isSuperAdmin();
    }

    /**
     * @description Manages data source connections.
     * @path /dataSources/{dataSourceId}
     * @allow (create) User can create a data source with their ID as the owner.
     * @allow (get, update, delete) User can access and modify their own data sources.
     * @deny (create) User cannot create a data source with a mismatched owner ID.
     * @deny (list)  User cannot list all data sources.
     * @principle Enforces data source ownership.
     */
    match /dataSources/{dataSourceId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }

      function isSignedIn() {
          return request.auth != null;
      }

      function isExistingOwner(ownerId) {
          return isSignedIn() && isOwner(ownerId) && resource.data.ownerId == request.auth.uid;
      }

      allow get: if isSignedIn() && isOwner(resource.data.ownerId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Manages role-based permissions for modules.
     * @path /permissions/{permissionId}
     * @allow (create, update, delete) Only the super-admin can manage role permissions.
     * @deny (get, list) Regular users cannot view or list permissions.
     * @principle Restricts permission management to the super-admin role.
     */
    match /permissions/{permissionId} {
      function isSuperAdmin() {
        return request.auth != null && request.auth.token.role == 'super-admin';
      }

      function isSignedIn() {
          return request.auth != null;
      }

      allow get: if isSignedIn() && isSuperAdmin();
      allow list: if false;
      allow create: if isSignedIn() && isSuperAdmin();
      allow update: if isSignedIn() && isSuperAdmin();
      allow delete: if isSignedIn() && isSuperAdmin();
    }
  }
}