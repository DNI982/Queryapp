rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (read, write, list): if request.auth.token.role == 'super-admin'
     * @allow (create): if request.auth.uid == userId && request.resource.data.email == request.auth.token.email
     * @allow (update): if request.auth.uid == userId && resource.data.email == request.auth.token.email
     * @deny (create): if request.auth.uid != userId
     * @deny (update): if request.auth.token.role != 'super-admin' && request.auth.uid != userId
     * @deny (delete): Always deny user deletion to prevent accidental data loss. Super-admins can manage this via backend functions.
     * @principle Enforces ownership for user profile writes and restricts modifications to super-admins and the user themselves.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false; // Listing users is generally disallowed.

      allow create: if isSelfCreate(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isSelfUpdate(userId);
      allow delete: if false; // Deletion should be handled via backend functions.
    }

    /**
     * @description Controls access to pending user registration documents.
     * @path /pendingUsers/{userId}
     * @allow (read, write, list): if request.auth.token.role == 'super-admin'
     * @deny (create, update, delete): if request.auth.token.role != 'super-admin'
     * @principle Restricts management of pending user registrations to super-admins only.
     */
    match /pendingUsers/{pendingUserId} {
      allow get, list, create, update, delete: if isSuperAdmin();
    }

    /**
     * @description Controls access to data source connection documents.
     * @path /dataSources/{dataSourceId}
     * @allow (read, write, list): if request.auth.token.role == 'super-admin'
     * @allow (create): if request.resource.data.ownerId == request.auth.uid
     * @allow (update, delete): if resource.data.ownerId == request.auth.uid
     * @deny (create, update, delete): if request.auth.token.role != 'super-admin' && request.resource.data.ownerId != request.auth.uid
     * @principle Enforces data source ownership and restricts modifications to owners and super-admins.
     */
    match /dataSources/{dataSourceId} {
      allow get, list: if isSignedIn() || isSuperAdmin();

      allow create: if isValidDataSourceCreateRequest();
      allow update: if isDataSourceOwner() || isSuperAdmin();
      allow delete: if isDataSourceOwner() || isSuperAdmin();
    }

      /**
       * @description Manages role-based permissions, configurable by the super-admin.
       * @path /permissions/{permissionId}
       * @allow (read, write, list): if request.auth.token.role == 'super-admin'
       * @deny (create, update, delete): if request.auth.token.role != 'super-admin'
       * @principle Ensures only super-admins can define and modify role permissions.
       */
    match /permissions/{permissionId} {
        allow get, list, create, update, delete: if isSuperAdmin();
    }

    // Recursive wildcard to apply default rules to all documents
    match /{document=**} {
       allow read: if isSuperAdmin();
       allow write: if false;
       allow list: if isSuperAdmin();
    }
  }

  // --- Helper Functions ---

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

    /**
   * @description Checks if the authenticated user has super admin role.
   * @return {boolean} True if the user is a super admin, false otherwise.
   */
  function isSuperAdmin() {
    return request.auth.token.role == 'super-admin';
  }

  /**
   * @description Checks if the authenticated user is the owner of the resource, using the document ID as userId.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

    /**
   * @description Checks if the authenticated user is creating their own user document and that the email matches.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is creating their own profile, false otherwise.
   */
  function isSelfCreate(userId) {
    return request.auth.uid == userId;
  }

  /**
   * @description Checks if the authenticated user is updating their own user document and that the email matches.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is updating their own profile, false otherwise.
   */
  function isSelfUpdate(userId) {
    return request.auth.uid == userId;
  }

  /**
   * @description Checks if the authenticated user is the owner of an existing resource, using the document ID as userId.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  /**
   * @description Checks if the authenticated user is the owner of the data source.
   * @param {string} dataSourceId The data source ID.
   * @return {boolean} True if the user owns the data source, false otherwise.
   */
  function isDataSourceOwner() {
      return request.auth.uid == resource.data.ownerId;
  }

  /**
   * @description Checks if the authenticated user is the owner of an existing data source.
   * @param {string} dataSourceId The data source ID.
   * @return {boolean} True if the user owns the data source and it exists, false otherwise.
   */
  function isExistingDataSourceOwner(dataSourceId) {
      return isDataSourceOwner() && resource != null;
  }

    /**
     * @description Validates the data source create request.
     * @return {boolean} True if the data source create request is valid, false otherwise.
     */
    function isValidDataSourceCreateRequest() {
        return isSignedIn() && request.resource.data.ownerId == request.auth.uid;
    }
}